
# TCP통신

## 내가 구현하려는 TCP 통신의 조건
### 첫째, 서버소켓의 IP주소는 remote에 있어 고정 IP여야한다. 
### 둘째, 원격으로 서버 소켓 생성과 종료를 할 수 있어야한다.
### 셋째, C#과 python으로 통신되어야한다.

첫번째 조건을 위해, aws를 사용
두번째 조건을 위해, 원격으로 함수를 실행하여 소켓 생성 및 종료 할 수 있도록한다. (방법1:url 접속 시 함수 실행으로,,, 방법2: RPC를 사용한다.)  
셋번째 조건을 위해, 클라이언트(유니티)에서 "원격 함수 실행" 및 "클라이언트 소켓 생성과 종료" 할 수 있도록 한다.  


```
# aws 장고

서버소켓 생성 url 추가하여 views 함수 실행
서버소켓 종료 url 추가하여 views 함수 실행
views.py의 함수로 서버소켓 생성 및 송 수신

```
```
# 유니티


```
서버(파이썬)
```python
# server.py

import socket
import time
from datetime import datetime

HOST = '127.0.0.1' 
PORT = 8000       

server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

server_socket.bind((HOST, PORT))

server_socket.listen()




client_socket, addr = server_socket.accept()

print('Connected by', addr)

k = 0

while True:
    
    msg = "first tcp messages " + str(k)
    client_socket.sendall(msg.encode())
    print('send 완료 '+ str(k) )
    k += 1
    time.sleep(2)
    if(k >= 5):
      client_socket.close()
      server_socket.close()
    
    '''
    무한 루프를 돌면서 2초에 한번씩 데이터를 송신함.
    만약 종료 조건을 넣고 싶다면 여기에 넣으면 됨
    '''

client_socket.close()
server_socket.close()
출처: https://run-a-way.tistory.com/63 [과제가 싫어서 도망쳐온 블로그:티스토리]
```

클라이언트(유니티)
```C#
# client.cs

using System.Collections;
using System.Collections.Generic;
using System.Net.Sockets;
using UnityEngine;
using System.Text;
using System;
using System.IO;
using System.Runtime.InteropServices;

public class TCPManager : MonoBehaviour
{
    TcpClient client;
    string serverIP = "127.0.0.1";
    int port = 5000;
    byte[] receivedBuffer;
    StreamReader reader;
    bool socketReady = false;
    NetworkStream stream;


    // Start is called before the first frame update
    void Start()
    {
       CheckReceive();
    }

    // Update is called once per frame
    void Update()
    {
        
        if(socketReady)
        {
            
            
            if (stream.DataAvailable)
            {
                receivedBuffer = new byte[100];
                stream.Read(receivedBuffer, 0, receivedBuffer.Length); // stream에 있던 바이트배열 내려서 새로 선언한 바이트배열에 넣기
                string msg = Encoding.UTF8.GetString(receivedBuffer, 0, receivedBuffer.Length); // byte[] to string
                Debug.Log(msg);
            }
            
        }
    }

    void CheckReceive()
    {
        if (socketReady) return;
        try
        {
            client = new TcpClient(serverIP, port);

            if (client.Connected)
            {                
                stream = client.GetStream();
                Debug.Log("Connect Success");
                socketReady = true;
            }
            
        }
        catch (Exception e)
        {
            Debug.Log("On client connect exception " + e);
        }

    }

    void OnApplicationQuit()
    {
        CloseSocket();
    }

    void CloseSocket()
    {
        if (!socketReady) return;

        reader.Close();
        client.Close();
        socketReady = false;
    }

}
출처: https://run-a-way.tistory.com/63 [과제가 싫어서 도망쳐온 블로그:티스토리]
```
